<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../paper-styles/typography.html">

<dom-module id="ud-step">
	<template>
		<style include="paper-material-styles">
			:host {
				display: flex;
				flex-direction: column;
				@apply --paper-material-elevation-1;
			}

			#content {
				margin: 24px;
			}

			#actions {
				padding: 24px;
				display: flex;
				flex-direction: row;
				flex-wrap: nowrap;
				justify-content: space-between;
			}

			.linear-actions {
				display: flex;
				flex-direction: row;
				justify-content: flex-end;
				flex: 1;
			}

			paper-button {
				@apply --paper-font-button;
				color: rgba(0, 0, 0, 0.83);
			}

			.continue-btn {
				color: var(--google-blue-500);
			}

			paper-button[disabled] {
				color: rgba(0, 0, 0, 0.50);
				background-color: transparent;
			}
		</style>
		<div id="content">
			<slot name="content"></slot>
		</div>
		<div id="actions">
			<slot name="actions" id="actionsSlot">
				<paper-button data-action="back" class="back-btn">Back</paper-button>
				<div class="linear-actions">
					<paper-button data-action="cancel">Cancel</paper-button>
					<paper-button data-action="continue" class="continue-btn">Continue</paper-button>
				</div>
			</slot>
		</div>
	</template>
	<script>
		{
			/**
			 * `ud-step`
			 * Material Design Step
			 *
			 * @customElement
			 * @polymer
			 * @memberof UrDeveloper
			 */
			class UdStepElement extends Polymer.Element {
				static get is() {
					return 'ud-step';
				}

				static get properties() {
					return {
						/**
						 * Step title
						 */
						title: {
							type: String,
							reflectToAttribute: true
						},

						editable: {
							type: Boolean
						},

						selected: {
							type: Boolean,
							reflectToAttribute: true
						},

						actions: {
							type: Array
						},

						completed: {
							type: Boolean
						},

						icon: {
							type: String
						},

						completedIcon: {
							type: String,
							value: 'ud:check-circle'
						},

						editableIcon: {
							type: String,
							value: 'ud:edit-circle'
						},

						currentIcon: {
							type: String,
							computed: '_computeCurrentIcon(completed, editable)',
							notify: true
						},

						_actionButtons: {
							type: Array
						}
					}
				}

				static get observers() {
					return ['_updateActionsButtons(_actionButtons.*,actions)']
				}

				ready() {
					super.ready();
					this._nodeObserver = new Polymer.FlattenedNodesObserver(this.$.actionsSlot, (info) => {
						this._actionButtons = Array.from(info.target.querySelectorAll('[data-action]'));
						this._actionButtons.filter(ab => !ab._hooked).forEach(ab => {
							ab.addEventListener('tap', (evt) => this._handleAction(evt));
						});
					});
				}

				_updateActionsButtons(actionButtons, allowedActions) {
					if (!actionButtons || !allowedActions) return;

					this._actionButtons.forEach(ab => {
						const actionName = ab.getAttribute('data-action');
						const action = this.actions.find(a => a.name === actionName);
						if (!action) {
							ab.style.display = 'none';
						} else {
							ab.disabled = action.disabled;
						}
					});
				}

				_handleAction(evt) {
					this.dispatchEvent(new CustomEvent('step-action', {
						detail: evt.target.getAttribute('data-action'),
						bubbles: true
					}));
				}

				_computeCurrentIcon(completed, editable) {
					if (completed) {
						return editable?this.editableIcon:this.completedIcon;
					}
					return this.icon;
				}
			}

			window.customElements.define(UdStepElement.is, UdStepElement);

			/**
			 * @namespace
			 */
			window.UrDeveloper = window.UrDeveloper || {};
			UrDeveloper.UdStepElement = UdStepElement;
		}
	</script>
</dom-module>