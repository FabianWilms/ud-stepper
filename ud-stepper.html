<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../polymer/lib/mixins/mutable-data.html">

<link rel="import" href="ud-step.html">
<link rel="import" href="ud-iconset.html">

<dom-module id="ud-stepper">
	<template>
		<style include="paper-material-styles">
			:host {
				display: flex;
				flex-direction: column;
			}

			.header-container {
				display: flex;
				flex-direction: row;

				flex-wrap: nowrap;
				align-items: center;
				@apply --paper-material-elevation-1;
			}

			.header {
				display: flex;
				flex-direction: row;
				max-height: 72px;
			}

			.header:not(:last-of-type) {
				flex: 1;
			}

			.header:not(:last-of-type):after {
				content: '';
				position: relative;
				flex: 1;
				top: 36px;
				height: 1px;
				margin-left: -12px;
				background-color: rgba(0, 0, 0, 0.1);
			}

			.header .label {
				display: flex;
				flex-direction: row;
				cursor: pointer;
				align-items: center;
				padding: 24px 24px 24px 24px;
			}

			.header .label:hover {
				background-color: #f0f0f0;
			}

			.label-icon {
				color: rgba(0, 0, 0, 0.38);
				@apply --paper-font-caption;
				text-align: center;
				line-height: 24px;
			}

			.label-text {
				@apply --paper-font-body2;
				padding-left: 8px;
				color: rgba(0, 0, 0, 0.54);
			}

			.header.selected .label-icon,
			.header[completed] .label-icon {
				color: var(--google-blue-500);
			}

			.header.selected .label-text,
			.header[completed] .label-text {
				color: rgba(0, 0, 0, 0.87);
			}

			.step-number {
				color: white;
				background-color: rgba(0, 0, 0, 0.38);
				border-radius: 50%;
				line-height: 24px;
				width: 24px;
				height: 24px;
				max-height: 24px;
				max-width: 24px;
			}

			.header.selected .step-number {
				background-color: var(--google-blue-500);
			}
		</style>
		<iron-selector id="selector" class="header-container" selectable=".header.selectable" selected-class="selected" selected="{{selectedStep}}"
		  on-iron-activate="_handleStepActivate" selected-attribute="selected">
			<dom-repeat items="[[_steps]]" mutable-data>
				<template>
					<div class="header selectable" completed$="[[item.completed]]">
						<div class="label">
							<div class="label-icon">
								<dom-if if="[[item.currentIcon]]">
									<template>
										<iron-icon icon="[[item.currentIcon]]"></iron-icon>
									</template>
								</dom-if>
								<dom-if if="[[!item.currentIcon]]">
									<template>
										<div class="step-number">[[_getStepNumber(index)]]</div>
									</template>
								</dom-if>
							</div>
							<div class="label-text">[[item.title]]</div>
						</div>
					</div>
				</template>
			</dom-repeat>
		</iron-selector>
		<iron-pages selected="{{selectedStep}}" selected-attribute="selected">
			<slot></slot>
		</iron-pages>
	</template>

	<script>
		{
			/**
			 * `ud-stepper`
			 * Material Design Stepper
			 *
			 * @customElement
			 * @polymer
			 * @memberof UrDeveloper
			 * @demo demo/index.html
			 */
			class UdStepperElement extends Polymer.MutableData(Polymer.Element) {
				static get is() {
					return 'ud-stepper';
				}

				static get properties() {
					return {

						/**
						 * Determines if the stepper is vertical.
						 */
						vertical: {
							type: Boolean,
							reflectToAttribute: Boolean
						},

						/**
						 * Determines if the stepper is linear.
						 */
						linear: {
							type: Boolean,
							reflectToAttribute: Boolean
						},

						_steps: {
							type: Array
						},

						selectedStep: {
							type: Boolean,
							notify: true
						}
					};
				}

				constructor() {
					super();
					this._templateObserver = new Polymer.FlattenedNodesObserver(this, info => {
						if (info.addedNodes.filter(this._isStep).length > 0 ||
							info.removedNodes.filter(this._isStep).length > 0) {
							this._steps = this._findSteps();
							this._prepareSteps(this._steps);
							this.selectedStep = 0;
						}
					});
				}

				ready() {
					super.ready();
					this.addEventListener('step-action', evt => this._handleStepAction(evt));
				}

				_findSteps() {
					return Array.from(this.querySelectorAll('ud-step'));
				}

				_prepareSteps(steps) {
					steps.forEach((step, i) => {
						const actions = [{
							name: 'continue'
						}, {
							name: 'cancel'
						}];
						if (!this.linear) {
							actions.push({
								name: 'back',
								disabled: i === 0
							});
						}
						step.actions = actions;
					});
				}

				_isStep(node) {
					return node.nodeType === Node.ELEMENT_NODE && /ud-step/i.test(node.localName);
				}

				_getStepNumber(index) {
					return index + 1;
				}

				_handleStepAction(evt) {
					this[evt.detail.toLowerCase()](evt.target);
				}

				continue (step) {
					step.completed = true;
					this.notifyPath('_steps');
					if (this.selectedStep < this._steps.length - 1) {
						this.selectedStep = this.selectedStep + 1;
					}
				}

				back(step) {
					if (this.selectedStep > 0) {
						this.selectedStep = this.selectedStep - 1;
					}
				}

				cancel(evt) {

				}

				_handleStepActivate(evt) {
					if (this.linear) {
						const step = this._steps[evt.detail.selected];
						if (!step.completed || !step.editable) {
							evt.preventDefault();
						}
					}
				}
			}

			window.customElements.define(UdStepperElement.is, UdStepperElement);

			/**
			 * @namespace
			 */
			window.UrDeveloper = window.UrDeveloper || {};
			UrDeveloper.UdStepperElement = UdStepperElement;
		}
	</script>
</dom-module>